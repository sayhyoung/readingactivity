<!DOCTYPE html>
 <html lang="ko">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
   <title>ğŸ›¡ ì˜ì–´ ì§€ë¬¸ ì•¡í‹°ë¹„í‹° ìƒì„± ë§ˆë²•ì‚¬ ğŸ›¡</title>
   <!-- Font Awesome for icons -->
   <link
     rel="stylesheet"
     href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
     crossorigin="anonymous"
   />
   <style>
     /* ê¸°ë³¸ ì´ˆê¸°í™” */
     * {
       box-sizing: border-box;
       margin: 0;
       padding: 0;
     }
     html, body {
       margin: 0;
       padding: 0;
       height: 100%;
       font-family: Arial, sans-serif;
       -webkit-font-smoothing: antialiased;
     }
     body {
       background-color: #f0f4c3;
     }
     .container {
       max-width: 900px;
       margin: 20px auto;
       background: #fff;
       padding: 20px;
       border-radius: 10px;
       box-shadow: 0 4px 8px rgba(0,0,0,0.1);
     }
     h1 {
       text-align: center;
       color: #33691e;
       margin-bottom: 20px;
     }
     .tabs {
       display: flex;
       justify-content: center;
       background: #8bc34a;
       padding: 10px;
       border-radius: 8px;
       margin-bottom: 20px;
       flex-wrap: wrap;
     }
     .tabs button {
       background: none;
       border: none;
       color: white;
       padding: 10px 20px;
       cursor: pointer;
       font-size: 20px;
       display: inline-flex;
       align-items: center;
       gap: 5px;
     }
     .tabs button:hover {
       background: #466127;
     }
     .section {
       margin-top: 20px;
       padding: 20px;
       border-radius: 8px;
       background: #ffffff;
       box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
     }
     textarea, input[type="file"] {
       width: 100%;
       margin-bottom: 15px;
       font-size: 16px;
       padding: 8px;
     }
     label {
       font-size: 16px;
       margin-right: 10px;
       display: inline-flex;
       align-items: center;
       gap: 5px;
     }
     button {
       background-color: #8bc34a;
       color: white;
       border: none;
       padding: 10px 15px;
       border-radius: 5px;
       cursor: pointer;
       font-size: 16px;
       margin-top: 10px;
       display: inline-flex;
       align-items: center;
       gap: 5px;
     }
     button:hover {
       background-color:  #466127;
     }
     #activity-loading-indicator {
       display: none;
       margin-top: 10px;
       color: red;
       font-weight: bold;
     }
     @media print {
       .tabs, button, #activity-loading-indicator {
         display: none !important;
       }
       .container {
         box-shadow: none;
       }
     }
     @media (max-width: 600px) {
       .container {
         margin: 10px auto;
         padding: 15px;
       }
       .tabs button {
         font-size: 14px;
         padding: 8px 16px;
         margin-bottom: 5px;
       }
       .section {
         margin-top: 10px;
         padding: 15px;
       }
       button {
         font-size: 14px;
       }
     }
     #activityOutputView {
       margin-top: 20px;
       padding: 10px;
       background-color: #f0f0f0;
       border-radius: 5px;
       line-height: 1.6;
     }
     #activity {
    line-height: 1.8;
  }
   </style>
   <!-- Tesseract.js (OCR) -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.4/tesseract.min.js"></script>
   <script>
     function showSection(sectionId) {
       const sections = ["upload", "activity", "activityCheck"];
       sections.forEach(id => {
         const sec = document.getElementById(id);
         if (sec) {
           sec.style.display = (id === sectionId) ? "block" : "none";
         }
       });
     }
 
     // ì´ë¯¸ì§€ -> OCR
     async function handleImageUpload() {
       const imageInput = document.getElementById('imageInput');
       const passageTextarea = document.getElementById('passage');
       if (imageInput.files && imageInput.files[0]) {
         const imageFile = imageInput.files[0];
         try {
           const { data: { text } } = await Tesseract.recognize(
             imageFile,
             'eng',
             { logger: m => console.log(m) }
           );
           passageTextarea.value = text;
           alert('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ!');
         } catch (error) {
           console.error("OCR Error:", error);
           alert('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨: ' + error);
         }
       } else {
         alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
       }
     }
 
     // í™œë™ ìƒì„±
     let activityData = null;
     async function generateActivity() {
       const passage = document.getElementById("passage").value.trim();
       if (!passage) {
         alert("ì§€ë¬¸ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”!");
         return;
       }
       const checks = document.querySelectorAll('.activity-type:checked');
       if (!checks.length) {
         alert("ìµœì†Œ í•œ ê°œ ì´ìƒì˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
         return;
       }
       const selectedActs = Array.from(checks).map(c => c.value);
 
       document.getElementById("activity-loading-indicator").style.display = "block";
 
       try 
         {
         const resp = await fetch("https://readingactivity.sehyunglee2015.workers.dev/api/activity", 
                                  {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({
             passage,
             activities: selectedActs
           })
         });
         if (!resp.ok) {
           const msg = await resp.text();
           throw new Error(`í™œë™ ìƒì„± API ì˜¤ë¥˜: ${resp.status} / ${msg}`);
         }
         const data = await resp.json();
         if (data.error) {
           throw new Error(data.error);
         }
         const result = data.result;
         if (!result || !Array.isArray(result.activities)) {
           throw new Error("ì˜¬ë°”ë¥´ì§€ ì•Šì€ í™œë™ ë°ì´í„°");
         }
 
         activityData = result;
         document.getElementById("activity-loading-indicator").style.display = "none";
         showSection('activityCheck');
         renderActivity(false);
       } catch (err) {
         console.error("í™œë™ ìƒì„± ì—ëŸ¬:", err);
         alert("í™œë™ ìƒì„± ì‹¤íŒ¨: " + err.message);
         document.getElementById("activity-loading-indicator").style.display = "none";
       }
     }
 
     function renderActivity(showAnswers) {
       if (!activityData) {
         document.getElementById("activityOutputView").innerHTML = "<p>ì•„ì§ ìƒì„±ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
         return;
       }
       const outputDiv = document.getElementById("activityOutputView");
       let html = "<h3>í™œë™ ê²°ê³¼</h3>";
 
       let totalAnswers = [];
 
       activityData.activities.forEach((act, idx) => {
         if (idx > 0) {
           html += `<div style="margin: 1rem 0;"></div>`;
         }
         html += `<h4>${act.type}</h4>`;
 
         // ê°€ë¡œ ì „ì²´ ë°‘ì¤„
         const lineLen = 80;
         let fullLine = "";
         for(let k=0;k<lineLen;k++){ fullLine+="_"; }
 
         // ë‹¨ì–´ ë° ì£¼ìš” í‘œí˜„ ìµíˆê¸°
         if (act.type === "ë‹¨ì–´ ë° ì£¼ìš” í‘œí˜„ ìµíˆê¸°" && act.items) {
           act.items.forEach((item, i) => {
             html += `
               <p style="margin-bottom:10px;">
                 ${i+1}) <strong>${item.vocab}</strong>: ${item.meaning}
                 <br/>${fullLine}
               </p>
             `;
           });
         }
         // ì˜ì–´ ë¬¸ì¥ í•´ì„í•˜ê¸°
         else if (act.type === "ì˜ì–´ ë¬¸ì¥ í•´ì„í•˜ê¸°" && act.sentences) {
           act.sentences.forEach((s, i) => {
             html += `
               <p style="margin-bottom:10px;">
                 ${i+1}) ${s.original}
                 <br/>${fullLine}
               </p>
             `;
             if (s.answer) {
               if (showAnswers) {
                 html += `<p style="color:blue;">[ì •ë‹µ] ${s.answer}</p>`;
               } else {
                 totalAnswers.push(`[ì˜ë¬¸í•´ì„ ${i+1}] ${s.answer}`);
               }
             }
           });
         }
         // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
         else if (act.type === "ë¹ˆ ì¹¸ ì±„ìš°ê¸°" && act.questions) {
           act.questions.forEach((qItem, i) => {
             html += `
               <p style="margin-bottom:10px;">
                 ${i+1}) ${qItem.sentence}
               </p>
             `;
             if(qItem.solution) {
               if(showAnswers) {
                 html += `<p style="color:blue;">[ì •ë‹µ] ${qItem.solution}</p>`;
               } else {
                 totalAnswers.push(`[ë¹ˆì¹¸ ${i+1}] ${qItem.solution}`);
               }
             }
           });
         }
         // ìš°ë¦¬ë§ ì˜ì–´ë¡œ ë²ˆì—­í•˜ê¸°
         else if (act.type === "ìš°ë¦¬ë§ ì˜ì–´ë¡œ ë²ˆì—­í•˜ê¸°" && act.list) {
           act.list.forEach((row, i) => {
             html += `
               <p style="margin-bottom:10px;">
                 ${i+1}) ${row.korean}
                 <br/>${fullLine}
               </p>
             `;
             if (row.answer) {
               if (showAnswers) {
                 html += `<p style="color:blue;">[ì •ë‹µ] ${row.answer}</p>`;
               } else {
                 totalAnswers.push(`[í•œ->ì˜ ${i+1}] ${row.answer}`);
               }
             }
           });
         }
         // ë¬¸ë²• ë³€í˜• í™œë™
         else if (act.type === "ë¬¸ë²• ë³€í˜• í™œë™" && act.examples) {
           act.examples.forEach((ex, i) => {
             html += `
               <p style="margin-bottom:10px;">
                 ${i+1}) [${ex.instruction}]<br/>
                 ì›ë¬¸: ${ex.original}
                 <br/>${fullLine}
               </p>
             `;
             if(ex.answer) {
               if(showAnswers) {
                 html += `<p style="color:blue;">[ì •ë‹µ] ${ex.answer}</p>`;
               } else {
                 totalAnswers.push(`[ë¬¸ë²•ë³€í˜• ${i+1}] ${ex.answer}`);
               }
             }
           });
         }
         else {
           html += `<p>í•´ë‹¹ í™œë™ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
         }
       });
 
       if(!showAnswers){
         html += `
           <div style="margin-top:20px;">
             <button onclick="showActivityAnswers()">
               <i class="fas fa-eye"></i> ì •ë‹µ
             </button>
             <button onclick="printPage()">
               <i class="fas fa-print"></i> ì›¹ í˜ì´ì§€ ì¸ì‡„
             </button>
           </div>
         `;
       }
       else {
         // ì •ë‹µ ëª¨ë“œ
         html += `
           <div style="margin-top:20px;">
             <button onclick="printPage()">
               <i class="fas fa-print"></i> ì›¹ í˜ì´ì§€ ì¸ì‡„
             </button>
           </div>
         `;
         if(totalAnswers.length>0){
           html += `<hr/><h4>ì •ë‹µ ëª¨ìŒ</h4><pre>`;
           totalAnswers.forEach(ans => {
             html += ans + "\n";
           });
           html += `</pre>`;
         }
       }
 
       document.getElementById("activityOutputView").innerHTML = html;
     }
 
     function showActivityAnswers() {
       renderActivity(true);
     }
 
     function printPage(){
       window.print();
     }
 
     function showSection(sectionId) {
       const sections = ["upload", "activity", "activityCheck"];
       sections.forEach(id => {
         const sec = document.getElementById(id);
         if (sec) {
           sec.style.display = (id === sectionId) ? "block" : "none";
         }
       });
     }
     // í˜ì´ì§€ ë¡œë“œì‹œ ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
     window.onload = () => {
       showSection('upload');
     };
     window.handleImageUpload = handleImageUpload;
     window.generateActivity = generateActivity;
     window.showActivityAnswers = showActivityAnswers;
     window.renderActivity = renderActivity;
     window.printPage = printPage;
   </script>
 </head>
 <body>
   <div class="container">
     <h1>ğŸ’« ì˜ì–´ ì§€ë¬¸ ì•¡í‹°ë¹„í‹° ìƒì„± ë§ˆë²•ì‚¬ ğŸ’«</h1>
     <div class="tabs">
       <button onclick="showSection('upload')"><i class="fas fa-upload"></i> ì§€ë¬¸ ì—…ë¡œë“œ</button>
       <button onclick="showSection('activity')"><i class="fas fa-chalkboard-teacher"></i> í™œë™ ìƒì„±</button>
       <button onclick="showSection('activityCheck')"><i class="fas fa-check-square"></i> í™œë™ í™•ì¸</button>
     </div>
 
     <!-- ì§€ë¬¸ ì—…ë¡œë“œ ì„¹ì…˜ -->
     <div id="upload" class="section">
       <h2><i class="fas fa-file-alt"></i> ì§€ë¬¸ ì—…ë¡œë“œ</h2>
       <textarea id="passage" placeholder="ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="6"></textarea>
       <input type="file" id="imageInput" accept="image/*">
       <button onclick="handleImageUpload()"><i class="fas fa-camera"></i> ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ</button>
       <!-- ìš”ì²­ì‚¬í•­: "ì…ë ¥ ì™„ë£Œ" ë²„íŠ¼ ë³µì› -->
       <button onclick="showSection('activity')"><i class="fas fa-check"></i> ì…ë ¥ ì™„ë£Œ</button>
     </div>
 
     <!-- í™œë™ ìƒì„± ì„¹ì…˜ -->
     <div id="activity" class="section" style="display:none;">
       <h2><i class="fas fa-chalkboard-teacher"></i> í™œë™ ìƒì„±</h2>
       <p>ğŸ‘‰ğŸ» ìƒì„±í•  í™œë™ì„ ì„ íƒí•˜ì„¸ìš”:</p>
       <div style="margin-bottom: 15px;">
         <label><input type="checkbox" class="activity-type" value="ë‹¨ì–´ ë° ì£¼ìš” í‘œí˜„ ìµíˆê¸°"> ë‹¨ì–´ ë° ì£¼ìš” í‘œí˜„ ìµíˆê¸°</label><br/>
         <label><input type="checkbox" class="activity-type" value="ì˜ì–´ ë¬¸ì¥ í•´ì„í•˜ê¸°"> ì˜ì–´ ë¬¸ì¥ í•´ì„í•˜ê¸°</label><br/>
         <label><input type="checkbox" class="activity-type" value="ë¹ˆ ì¹¸ ì±„ìš°ê¸°"> ë¹ˆ ì¹¸ ì±„ìš°ê¸°</label><br/>
         <label><input type="checkbox" class="activity-type" value="ìš°ë¦¬ë§ ì˜ì–´ë¡œ ë²ˆì—­í•˜ê¸°"> ìš°ë¦¬ë§ ì˜ì–´ë¡œ ë²ˆì—­í•˜ê¸°</label><br/>
         <label><input type="checkbox" class="activity-type" value="ë¬¸ë²• ë³€í˜• í™œë™"> ë¬¸ë²• ë³€í˜• í™œë™</label><br/>
       </div>
       <button onclick="generateActivity()"><i class="fas fa-play"></i> í™œë™ ìƒì„±</button>
       <div id="activity-loading-indicator">
        í™œë™ ìƒì„± ì¤‘... <i class="fas fa-spinner fa-spin"></i>
       </div>
     </div>
 
     <!-- í™œë™ í™•ì¸ ì„¹ì…˜ -->
     <div id="activityCheck" class="section" style="display:none;">
       <h2><i class="fas fa-check-square"></i> í™œë™ í™•ì¸</h2>
       <div id="activityOutputView"></div>
     </div>
   </div>
 </body>
 </html>
